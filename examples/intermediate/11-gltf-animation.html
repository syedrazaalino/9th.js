<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale.0">
    <title>GLTF Animation Demo</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 300px;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            color: white;
            max-width: 250px;
        }
        .control-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-size: 12px; }
        input[type="range"] { width: 100%; }
        button {
            margin: 2px;
            padding: 5px 10px;
            background: #444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover { background: #666; }
        button.active { background: #007acc; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="info">
        <strong>GLTF Animation Demo</strong><br>
        Model loading and animation system<br>
        - Procedural character model<br>
        - Multiple animation clips<br>
        - Animation blending<br>
        - Bone manipulation
    </div>
    
    <div id="controls">
        <div class="control-group">
            <button onclick="setAnimation('idle')" class="active">Idle</button>
            <button onclick="setAnimation('walk')">Walk</button>
            <button onclick="setAnimation('run')">Run</button>
            <button onclick="setAnimation('dance')">Dance</button>
            <button onclick="setAnimation('fight')">Fight</button>
        </div>
        <div class="control-group">
            <label>Animation Speed: <span id="speed-val">1.0</span></label>
            <input type="range" id="animation-speed" min="0" max="3" step="0.1" value="1.0">
        </div>
        <div class="control-group">
            <label>Blend Weight: <span id="blend-val">1.0</span></label>
            <input type="range" id="blend-weight" min="0" max="1" step="0.01" value="1.0">
        </div>
        <div class="control-group">
            <button onclick="toggleWireframe()">Toggle Wireframe</button>
            <button onclick="randomizeCharacter()">Randomize</button>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "../node_modules/three/build/three.module.js",
            "three/addons/": "../node_modules/three/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2c3e50);
        scene.fog = new THREE.Fog(0x2c3e50, 10, 50);

        // Camera
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(8, 6, 8);
        camera.lookAt(0, 3, 0);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 3, 0);
        controls.enableDamping = true;

        // Procedural Character Model
        class ProceduralCharacter {
            constructor() {
                this.skeleton = new THREE.Group();
                this.meshes = [];
                this.animations = {};
                this.currentAnimation = 'idle';
                this.animationTime = 0;
                this.animationSpeed = 1.0;
                this.blendWeight = 1.0;
                this.wireframe = false;

                this.createCharacter();
                this.createAnimations();
            }

            createCharacter() {
                // Create simple humanoid character
                const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xe74c3c });
                const limbMaterial = new THREE.MeshLambertMaterial({ color: 0x3498db });
                const headMaterial = new THREE.MeshLambertMaterial({ color: 0xf5deb3 });

                // Torso
                const torso = new THREE.Mesh(
                    new THREE.BoxGeometry(1, 2, 0.6),
                    bodyMaterial
                );
                torso.position.y = 2;
                torso.castShadow = true;
                torso.receiveShadow = true;
                this.skeleton.add(torso);
                this.meshes.push(torso);

                // Head
                const head = new THREE.Mesh(
                    new THREE.BoxGeometry(0.8, 0.8, 0.8),
                    headMaterial
                );
                head.position.y = 3.5;
                head.castShadow = true;
                head.receiveShadow = true;
                this.skeleton.add(head);
                this.meshes.push(head);

                // Arms
                const leftArm = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 1.5, 0.3),
                    limbMaterial
                );
                leftArm.position.set(-0.8, 2.5, 0);
                leftArm.castShadow = true;
                leftArm.receiveShadow = true;
                this.skeleton.add(leftArm);
                this.meshes.push(leftArm);

                const rightArm = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 1.5, 0.3),
                    limbMaterial
                );
                rightArm.position.set(0.8, 2.5, 0);
                rightArm.castShadow = true;
                rightArm.receiveShadow = true;
                this.skeleton.add(rightArm);
                this.meshes.push(rightArm);

                // Legs
                const leftLeg = new THREE.Mesh(
                    new THREE.BoxGeometry(0.4, 2, 0.4),
                    limbMaterial
                );
                leftLeg.position.set(-0.3, 0.5, 0);
                leftLeg.castShadow = true;
                leftLeg.receiveShadow = true;
                this.skeleton.add(leftLeg);
                this.meshes.push(leftLeg);

                const rightLeg = new THREE.Mesh(
                    new THREE.BoxGeometry(0.4, 2, 0.4),
                    limbMaterial
                );
                rightLeg.position.set(0.3, 0.5, 0);
                rightLeg.castShadow = true;
                rightLeg.receiveShadow = true;
                this.skeleton.add(rightLeg);
                this.meshes.push(rightLeg);

                // Store mesh references for animation
                this.bodyParts = {
                    torso, head, leftArm, rightArm, leftLeg, rightLeg
                };

                scene.add(this.skeleton);
            }

            createAnimations() {
                // Define animation keyframes
                this.animations = {
                    idle: {
                        duration: 2.0,
                        keyframes: [
                            { time: 0.0, rotations: { head: [0, 0, 0] } },
                            { time: 1.0, rotations: { head: [0.1, 0, 0] } },
                            { time: 2.0, rotations: { head: [0, 0, 0] } }
                        ]
                    },
                    walk: {
                        duration: 1.0,
                        keyframes: [
                            {
                                time: 0.0,
                                rotations: {
                                    leftArm: [0, 0, 0.5],
                                    rightArm: [0, 0, -0.5],
                                    leftLeg: [0.3, 0, 0],
                                    rightLeg: [-0.3, 0, 0]
                                }
                            },
                            {
                                time: 0.5,
                                rotations: {
                                    leftArm: [0, 0, -0.5],
                                    rightArm: [0, 0, 0.5],
                                    leftLeg: [-0.3, 0, 0],
                                    rightLeg: [0.3, 0, 0]
                                }
                            },
                            {
                                time: 1.0,
                                rotations: {
                                    leftArm: [0, 0, 0.5],
                                    rightArm: [0, 0, -0.5],
                                    leftLeg: [0.3, 0, 0],
                                    rightLeg: [-0.3, 0, 0]
                                }
                            }
                        ]
                    },
                    run: {
                        duration: 0.6,
                        keyframes: [
                            {
                                time: 0.0,
                                rotations: {
                                    torso: [0.1, 0, 0],
                                    head: [0.2, 0, 0],
                                    leftArm: [0, 0, 1.0],
                                    rightArm: [0, 0, -1.0],
                                    leftLeg: [0.6, 0, 0],
                                    rightLeg: [-0.6, 0, 0]
                                }
                            },
                            {
                                time: 0.3,
                                rotations: {
                                    torso: [-0.1, 0, 0],
                                    head: [-0.2, 0, 0],
                                    leftArm: [0, 0, -1.0],
                                    rightArm: [0, 0, 1.0],
                                    leftLeg: [-0.6, 0, 0],
                                    rightLeg: [0.6, 0, 0]
                                }
                            },
                            {
                                time: 0.6,
                                rotations: {
                                    torso: [0.1, 0, 0],
                                    head: [0.2, 0, 0],
                                    leftArm: [0, 0, 1.0],
                                    rightArm: [0, 0, -1.0],
                                    leftLeg: [0.6, 0, 0],
                                    rightLeg: [-0.6, 0, 0]
                                }
                            }
                        ]
                    },
                    dance: {
                        duration: 3.0,
                        keyframes: [
                            {
                                time: 0.0,
                                rotations: {
                                    torso: [0, 0, 0],
                                    head: [0, 0, 0],
                                    leftArm: [0, 0, 0],
                                    rightArm: [0, 0, 0]
                                }
                            },
                            {
                                time: 0.5,
                                rotations: {
                                    torso: [0, 0, 0.2],
                                    head: [0, 0.3, 0],
                                    leftArm: [0.5, 0, 0.5],
                                    rightArm: [-0.5, 0, -0.5]
                                }
                            },
                            {
                                time: 1.0,
                                rotations: {
                                    torso: [0, 0, -0.2],
                                    head: [0, -0.3, 0],
                                    leftArm: [-0.5, 0, -0.5],
                                    rightArm: [0.5, 0, 0.5]
                                }
                            },
                            {
                                time: 1.5,
                                rotations: {
                                    torso: [0.3, 0, 0],
                                    head: [0, 0.5, 0],
                                    leftArm: [1.0, 0, 0],
                                    rightArm: [1.0, 0, 0]
                                }
                            },
                            {
                                time: 2.0,
                                rotations: {
                                    torso: [-0.3, 0, 0],
                                    head: [0, -0.5, 0],
                                    leftArm: [1.0, 0, Math.PI/4],
                                    rightArm: [1.0, 0, -Math.PI/4]
                                }
                            },
                            {
                                time: 2.5,
                                rotations: {
                                    torso: [0, 0, 0],
                                    head: [0, 0, 0],
                                    leftArm: [0, 0, 0],
                                    rightArm: [0, 0, 0]
                                }
                            },
                            {
                                time: 3.0,
                                rotations: {
                                    torso: [0, 0, 0],
                                    head: [0, 0, 0],
                                    leftArm: [0, 0, 0],
                                    rightArm: [0, 0, 0]
                                }
                            }
                        ]
                    },
                    fight: {
                        duration: 1.5,
                        keyframes: [
                            {
                                time: 0.0,
                                rotations: {
                                    torso: [0, 0, 0],
                                    leftArm: [0, 0, 0],
                                    rightArm: [0, 0, 0],
                                    leftLeg: [0, 0, 0],
                                    rightLeg: [0, 0, 0.2]
                                }
                            },
                            {
                                time: 0.3,
                                rotations: {
                                    torso: [0, 0.1, 0],
                                    leftArm: [-0.5, 0, 0],
                                    rightArm: [0.5, 0, 0],
                                    leftLeg: [0, 0, -0.2],
                                    rightLeg: [0, 0, 0]
                                }
                            },
                            {
                                time: 0.6,
                                rotations: {
                                    torso: [0, -0.1, 0],
                                    leftArm: [0, 0, 0.5],
                                    rightArm: [0, 0, -0.5],
                                    leftLeg: [0, 0, 0],
                                    rightLeg: [0, 0, -0.1]
                                }
                            },
                            {
                                time: 0.9,
                                rotations: {
                                    torso: [0, 0.1, 0],
                                    leftArm: [0.5, 0, 0],
                                    rightArm: [-0.5, 0, 0],
                                    leftLeg: [0, 0, 0.2],
                                    rightLeg: [0, 0, 0]
                                }
                            },
                            {
                                time: 1.2,
                                rotations: {
                                    torso: [0, -0.1, 0],
                                    leftArm: [0, 0, -0.5],
                                    rightArm: [0, 0, 0.5],
                                    leftLeg: [0, 0, 0],
                                    rightLeg: [0, 0, 0.1]
                                }
                            },
                            {
                                time: 1.5,
                                rotations: {
                                    torso: [0, 0, 0],
                                    leftArm: [0, 0, 0],
                                    rightArm: [0, 0, 0],
                                    leftLeg: [0, 0, 0],
                                    rightLeg: [0, 0, 0]
                                }
                            }
                        ]
                    }
                };
            }

            setAnimation(animationName) {
                if (this.animations[animationName]) {
                    this.currentAnimation = animationName;
                    this.animationTime = 0;
                }
            }

            update(deltaTime) {
                this.animationTime += deltaTime * this.animationSpeed;

                const animation = this.animations[this.currentAnimation];
                if (!animation) return;

                // Loop animation
                if (this.animationTime > animation.duration) {
                    this.animationTime = 0;
                }

                // Interpolate keyframes
                this.interpolateKeyframes(animation);
            }

            interpolateKeyframes(animation) {
                const keyframes = animation.keyframes;
                
                // Find surrounding keyframes
                let currentKeyframe = keyframes[0];
                let nextKeyframe = keyframes[1];

                for (let i = 0; i < keyframes.length - 1; i++) {
                    if (this.animationTime >= keyframes[i].time && this.animationTime <= keyframes[i + 1].time) {
                        currentKeyframe = keyframes[i];
                        nextKeyframe = keyframes[i + 1];
                        break;
                    }
                }

                // Calculate interpolation factor
                const t1 = currentKeyframe.time;
                const t2 = nextKeyframe.time;
                const alpha = (this.animationTime - t1) / (t2 - t1);

                // Apply rotations with blending
                for (const partName in currentKeyframe.rotations) {
                    if (this.bodyParts[partName] && currentKeyframe.rotations[partName] && nextKeyframe.rotations[partName]) {
                        const current = currentKeyframe.rotations[partName];
                        const next = nextKeyframe.rotations[partName];
                        
                        const part = this.bodyParts[partName];
                        part.rotation.x = (current[0] + (next[0] - current[0]) * alpha) * this.blendWeight;
                        part.rotation.y = (current[1] + (next[1] - current[1]) * alpha) * this.blendWeight;
                        part.rotation.z = (current[2] + (next[2] - current[2]) * alpha) * this.blendWeight;
                    }
                }
            }

            randomize() {
                // Randomize colors
                const colors = [0xe74c3c, 0x3498db, 0x2ecc71, 0xf39c12, 0x9b59b6, 0x1abc9c];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                this.meshes.forEach(mesh => {
                    mesh.material.color.setHex(randomColor);
                });
            }

            toggleWireframe() {
                this.wireframe = !this.wireframe;
                this.meshes.forEach(mesh => {
                    mesh.material.wireframe = this.wireframe;
                });
            }
        }

        // Create character
        const character = new ProceduralCharacter();

        // Ground plane
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x34495e });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(10, 15, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 100;
        directionalLight.shadow.camera.left = -10;
        directionalLight.shadow.camera.right = 10;
        directionalLight.shadow.camera.top = 10;
        directionalLight.shadow.camera.bottom = -10;
        scene.add(directionalLight);

        // Global functions
        window.setAnimation = (animationName) => {
            character.setAnimation(animationName);
            
            // Update button states
            document.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        };

        window.randomizeCharacter = () => {
            character.randomize();
        };

        window.toggleWireframe = () => {
            character.toggleWireframe();
        };

        // Control bindings
        const speedSlider = document.getElementById('animation-speed');
        const speedDisplay = document.getElementById('speed-val');
        speedSlider.addEventListener('input', (e) => {
            character.animationSpeed = parseFloat(e.target.value);
            speedDisplay.textContent = e.target.value;
        });

        const blendSlider = document.getElementById('blend-weight');
        const blendDisplay = document.getElementById('blend-val');
        blendSlider.addEventListener('input', (e) => {
            character.blendWeight = parseFloat(e.target.value);
            blendDisplay.textContent = e.target.value;
        });

        // Animation loop
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = clock.getDelta();

            character.update(deltaTime);

            controls.update();
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
